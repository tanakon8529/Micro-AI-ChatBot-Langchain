# fastapi-ai-chat/dockerfile
FROM python:3.12-slim

# Install required system dependencies
RUN apt-get update && apt-get install -y \
    python3-dev \
    libpq-dev \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1
ENV TZ=Asia/Bangkok
ENV PORT_FASTAPI_AI_CHAT=80

# Set work directory
WORKDIR /app

# Copy requirements first for caching
COPY ./share/requirements.txt /app/requirements.txt

# Install pip and project dependencies
RUN python -m pip install --upgrade pip && \
    pip install -r requirements.txt

# Create necessary directories with proper permissions
RUN mkdir -p /app/service/core \
    /app/service/data/faiss_index \
    /app/service/middlewares \
    /app/service/settings \
    /app/service/utilities \
    && chmod -R 755 /app/service

# Copy shared modules and resources
COPY ./share/core/ /app/service/core/
COPY ./share/data/ /app/service/data/
COPY ./share/middlewares/ /app/service/middlewares/
COPY ./share/settings/ /app/service/settings/
COPY ./share/utilities/ /app/service/utilities/

# Copy PDF files to the correct location
COPY ./share/data/*.pdf /app/service/data/

# Copy service-specific code
COPY ./fastapi-ai-chat/ /app/service/

# Copy startup and alembic init scripts and make them executable
COPY ./fastapi-ai-chat/start.sh /app/service/
RUN chmod +x /app/service/start.sh

# Set the working directory to service directory
WORKDIR /app/service

# Create symlinks for backward compatibility
RUN ln -s /app/service/core core && \
    ln -s /app/service/data data && \
    ln -s /app/service/middlewares middlewares && \
    ln -s /app/service/settings settings && \
    ln -s /app/service/utilities utilities

CMD ["./start.sh"]